<!-- ==========================================================================
     Fichier : game.component.html
     Description :
     Template principal du composant GameComponent
     - Affichage du plateau de jeu et des scores
     - Gestion des contrôles (nouvelle partie, passer tour, changer difficulté)
     - Panneau de statistiques et Top 10
     - Modale de sélection de difficulté
     - Modale de fin de partie (endgame)
========================================================================== -->

<div class="game-container">

  <!-- Titre principal du jeu -->
  <h1 class="game-title">OTHELLO AI</h1>

  <!-- ------------------------------
       Section Statistiques & Top 10
  ------------------------------ -->
  <div class="cta-stats-wrapper">

    <!-- Boutons Accueil / Affichage Statistiques -->
    <div class="home-btn-panel">
      <button class="home-button" (click)="goHome()">Accueil</button>
      <button class="toggle-stats-btn" (click)="toggleStatsPanel()">
        <span>{{ showStats ? 'Fermer Statistiques' : 'Voir Statistiques' }}</span>
        <span class="arrow" [class.open]="showStats">▼</span>
      </button>
    </div>

    <!-- Panneau Statistiques (ouvert/fermé selon showStats) -->
    <div class="stats-panel-wrapper" [class.open]="showStats">
      <div class="stats-panel">
        <div class="stats-content">

          <!-- Côté gauche : Sélection de difficulté + taux de victoire -->
          <div class="stats-left">
            <label class="difficulty-select-wrapper">
              Difficulté :
              <div class="custom-select">
                <select [(ngModel)]="selectedDifficulty" (change)="updateStats()">
                  <option *ngFor="let diff of difficulties" 
                          [value]="diff"
                          [ngStyle]="{'background-color': [getDifficultyConfig(diff).color]}">
                          {{ getDifficultyConfig(diff).icon }} {{ diff }}
                  </option>
                </select>
                <span class="arrow">▼</span>
              </div>
            </label>

            <!-- Affichage graphique des taux de victoire -->
            <div class="win-rates">
              <div class="rate">
                <span class="label">IA</span>
                <div class="bar ia" [style.width.%]="aiWinRate">{{ aiWinRate }}%</div>
              </div>
              <div class="rate">
                <span class="label">Joueur</span>
                <div class="bar player" [style.width.%]="playerWinRate">{{ playerWinRate }}%</div>
              </div>
            </div>

            <p class="total-games">Total Parties : {{ totalGames }}</p>
          </div>

          <!-- Côté droit : Top 10 meilleurs scores -->
          <div class="stats-right">
            <h4>Top 10 Meilleurs Scores</h4>
            <ul>
              <li *ngFor="let score of top10; let i = index">
                <span class="rank">#{{ i + 1 }}</span>
                <span class="player-name">{{ score.name }}</span>
                <span class="player-score">{{ score.playerScore }}</span>
                <span class="vs">vs</span>
                <span class="ai-score">{{ score.aiScore }}</span>
              </li>
            </ul>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- ------------------------------
       Layout principal : Plateau + Sidebar
  ------------------------------ -->
  <div class="game-layout">

    <!-- Plateau de jeu -->
    <section class="board-section">
      <app-boardgame
        #boardGame
        [size]="8"
        [difficulty]="selectedDifficulty"
        (playerTurnChange)="currentTurn = $event"
        (scoreChange)="updateScores($event)"
        (aiThinkingChange)="aiThinking = $event">
      </app-boardgame>
    </section>

    <!-- Sidebar : Scores et Contrôles -->
    <aside class="sidebar">

      <!-- Carte des scores et indicateur de tour -->
      <div class="card score-card">

        <!-- Indicateur du joueur dont c’est le tour -->
        <div class="turn-indicator">
          <div class="player-icon">
            <div class="pawn" [ngClass]="currentTurn === 'IA' ? 'ia' : 'player'"></div>
          </div>
          <span class="turn-text" [ngClass]="currentTurn === 'IA' ? 'ia-text' : 'player-text'">
            {{ currentTurn === 'IA' ? "Tour de l'IA" : "Tour du Joueur" }}
          </span>
        </div>

        <!-- Message si l'IA réfléchit -->
        <div *ngIf="currentTurn === 'IA' && aiThinking" class="thinking-msg">
          L'IA réfléchit...
        </div>

        <!-- Scores joueurs -->
        <h2>Scores</h2>
        <div class="score-horizontal-wrapper">

          <!-- Score joueur -->
          <div class="side left">
            <div class="label-icon">
              <span class="label">Joueur</span>
              <div class="player-icon rotate-reverse">
                <div class="pawn player"></div>
              </div>
            </div>
            <span class="score-value">{{ playerScore }}</span>
          </div>

          <!-- Texte VS -->
          <div class="vs-text">VS</div>

          <!-- Score IA -->
          <div class="side right">
            <div class="label-icon">
              <span class="label">IA</span>
              <div class="player-icon rotate">
                <div class="pawn ia"></div>
              </div>
            </div>
            <span class="score-value">{{ aiScore }}</span>
          </div>

        </div>
      </div>

      <!-- Carte Contrôles : boutons et info difficulté -->
      <div class="card controls-card">
        <h2>Contrôles</h2>

        <!-- Affichage difficulté actuelle -->
        <div class="current-difficulty">
          <span>Difficulté actuelle :</span>
          <span class="badge" [ngStyle]="{'background-color': difficultyConfig[selectedDifficulty].color}">
            {{ selectedDifficulty }} {{ difficultyConfig[selectedDifficulty].icon }}
          </span>
        </div>

        <!-- Boutons actions -->
        <button class="btn-cta warning"
                *ngIf="currentTurn === 'Joueur' && validMovesCount === 0"
                (click)="boardGame.passTurn()">
          Passer mon tour
        </button>
        <button class="btn-cta" (click)="newGame()">Nouvelle Partie</button>
        <button class="btn-cta secondary" (click)="toggleDifficultyModal()">Changer Difficulté</button>
      </div>

    </aside>

  </div>

  <!-- ------------------------------
       Modale de changement de difficulté
  ------------------------------ -->
  <div class="difficulty-modal" [class.open]="showDifficultyModal">
    <div class="modal-content">
      <button class="close-btn" (click)="toggleDifficultyModal()">✕</button>
      <h3>Choisir une difficulté</h3>
      <ul>
        <li *ngFor="let diff of difficulties" 
            (click)="changeDifficulty(diff)"
            [ngStyle]="{'background-color': difficultyConfig[diff].color}">
          {{ diff }} {{ difficultyConfig[diff].icon }}
        </li>
      </ul>
    </div>
  </div>

  <!-- Badge affichant le nombre de coups valides -->
  <div class="valid-moves-badge">
    Nombre de positions possibles : {{ validMovesCount }}
  </div>
  
 <!-- Boutons debug pour tests 
  <button class="debug-btn" (click)="forceEndgame()">Debug Endgame</button>
  <button (click)="testTop10EntryPanel()">Tester panneau Top10</button>
 -->

  <!-- ------------------------------
       Modale de fin de partie (Endgame)
  ------------------------------ -->
  <div class="endgame-modal" *ngIf="showEndgame" role="dialog" aria-modal="true" aria-label="Fin de la partie">
    <div class="modal-content" [ngClass]="endgameClass">

      <!-- En-tête : message de fin et difficulté -->
      <div class="endgame-header">
        <h2>{{ endgameMessage }}</h2>
        <div class="current-difficulty">
          <span>Difficulté actuelle :</span>
          <span class="badge" [ngStyle]="{'background-color': difficultyConfig[selectedDifficulty].color}">
            {{ selectedDifficulty }} {{ difficultyConfig[selectedDifficulty].icon }}
          </span>
        </div>

        <!-- Scores finaux -->
        <div class="score-wrapper">
          <div class="player-score">
            <div class="pawn player" aria-hidden="true"></div>
            <span class="score-value">{{ playerScore }}</span>
          </div>

          <div class="vs">VS</div>

          <div class="player-score">
            <div class="pawn ia" aria-hidden="true"></div>
            <span class="score-value">{{ aiScore }}</span>
          </div>
        </div>
      </div>

      <!-- Section Stats et Top10 Entry -->
      <div class="stats-wrapper">

        <!-- Stats joueur / IA -->
        <div class="stats-left">
          <div class="win-rates">
            <div class="rate">
              <span class="label">IA</span>
              <div class="bar ia" [style.width.%]="aiWinRate">{{ aiWinRate }}%</div>
            </div>
            <div class="rate">
              <span class="label">Joueur</span>
              <div class="bar player" [style.width.%]="playerWinRate">{{ playerWinRate }}%</div>
            </div>
          </div>
          <p class="total-games">Total parties : {{ totalGames }}</p>
        </div>

        <!-- Panel Top10 / Saisie pseudo -->
        <div class="stats-right">

          <!-- Saisie pour entrer dans le Top 10 -->
          <div *ngIf="showTop10EntryPanel" class="top10-entry-panel">
            <h4>Félicitations !</h4>
            <p>Vous pouvez entrer dans le Top 10 pour la difficulté <strong>{{ selectedDifficulty }}</strong>.</p>

            <label class="input-row">
              <input
                type="text"
                title="Pseudo"
                [(ngModel)]="top10PlayerName"
                [disabled]="submittingTop10"
                placeholder="Player-123" />
              <div class="error-message" *ngIf="top10NameError">
                {{ top10NameError }}
              </div>
            </label>

            <div class="entry-actions">
              <button class="btn-cta" (click)="submitTop10Name()" [disabled]="submittingTop10 || !top10PlayerName">
                {{ submittingTop10 ? 'Enregistrement…' : 'Valider' }}
              </button>
              <button class="btn-cta secondary" (click)="showTop10EntryPanel = false" [disabled]="submittingTop10">
                Annuler
              </button>
            </div>
          </div>

          <!-- Vue Top10 ou changement de difficulté -->
          <div *ngIf="!showTop10EntryPanel" class="panel-viewport">
            <div class="panel-slider" [style.transform]="panelTransform">

              <!-- Top 10 -->
              <div class="panel top10-panel">
                <h4>Top 10 Meilleurs Scores</h4>
                <ul>
                  <li *ngFor="let score of top10; let i = index">
                    <span class="rank">#{{ i + 1 }}</span>
                    <span class="player-name">{{ score.name }}</span>
                    <span class="player-score">{{ score.playerScore }}</span>
                    <span class="vs">vs</span>
                    <span class="ai-score">{{ score.aiScore }}</span>
                  </li>
                </ul>
              </div>

              <!-- Changement de difficulté -->
              <div class="panel change-difficulty-panel">
                <h4>Choisir une difficulté</h4>
                <ul>
                  <li *ngFor="let diff of difficulties"
                      [ngStyle]="{'background-color': difficultyConfig[diff].color}"
                      (click)="changeDifficulty(diff)">
                    {{ diff }} {{ difficultyConfig[diff].icon }}
                  </li>
                </ul>
              </div>

            </div>
          </div>

        </div>
      </div>

      <!-- Boutons actions après la fin de partie -->
      <div class="endgame-buttons">
        <button class="btn-cta" (click)="newGame()">Rejouer</button>
        <button 
          class="btn-cta secondary" 
          (click)="openEndgameDifficultyPanel()"
          [disabled]="showTop10EntryPanel">
          {{ endgamePanel === 'top10' ? 'Changer difficulté' : 'Retour' }}
        </button>
        <button class="btn-cta secondary" (click)="goHome()">Menu</button>
      </div>

    </div>
  </div>

</div>
